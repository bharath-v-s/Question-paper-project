<!DOCTYPE html>
<html>
<head>
    <title>University QP Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>.grid-input { width: 60px; display: inline-block; }</style>
</head>
<body class="bg-light p-5">
    <div class="container bg-white p-4 shadow rounded">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <h2 class="text-primary">Question Paper Form</h2>
        <hr>

        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="form-label">School</label>
                <select id="school" class="form-select" onchange="loadDepts()">
                    <option value="">Select School</option>
                    {% for s in schools %}
                        <option value="{{s.id}}">{{s.name}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Graduate Type</label>
                <select id="level" class="form-select" onchange="updateSemesterDropdown(); loadDepts();">
                    <option value="UG">UG</option>
                    <option value="PG">PG</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Semester</label>
                <select id="semester" class="form-select" onchange="loadSubjects()">
                    <option value="">Select Semester</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Department</label>
                <select id="dept" class="form-select" onchange="loadSubjects()">
                    <option value="">Select Department</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Subject</label>
                <select id="subject" class="form-select" onchange="updateSubjectAndGrid()">
                    <option value="">Select Subject</option>
                </select>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="p-3 border rounded bg-light">
                    <label class="form-label fw-bold">1. Upload Question Bank (Excel/CSV)</label>
                    <div class="input-group">
                        <input type="file" id="bankFile" class="form-control">
                        <button type="button" class="btn btn-success" onclick="uploadBank()">Upload Bank</button>
                    </div>
                    <div id="uploadStatus" class="mt-2 small fw-bold"></div>
                </div>
            </div>
        </div>

        <form action="/generate" method="post" id="generate-form">
            <input type="hidden" name="subject_id" id="hidden_subject_id">
            
            <h4>2. Unit-wise Weightage Grid</h4>
            <p class="text-muted small">Enter the number of questions to pick from each unit.</p>
            <table class="table table-bordered text-center align-middle">
                <thead class="table-primary" id="grid-header"></thead>
                <tbody id="grid">
                    <tr><td colspan='4'>Please select a subject to see the weightage grid.</td></tr>
                </tbody>
            </table>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary btn-lg w-100">3. Generate Paper</button>
            </div>
        </form>
    </div>

<script>
    window.onload = function() { updateSemesterDropdown(); };

    // Function to handle both updating the hidden ID and rendering the grid
    function updateSubjectAndGrid() {
        const subId = document.getElementById('subject').value;
        document.getElementById('hidden_subject_id').value = subId;
        renderGrid();
    }

    function updateSemesterDropdown() {
        const level = document.getElementById('level').value;
        const semSelect = document.getElementById('semester');
        semSelect.innerHTML = '<option value="">Select Semester</option>'; 
        let maxSem = (level === "UG") ? 6 : 4;
        for (let i = 1; i <= maxSem; i++) {
            let opt = document.createElement("option");
            opt.value = i; opt.text = "Semester " + i;
            semSelect.appendChild(opt);
        }
        loadSubjects();
    }

    function loadDepts() {
        let sid = document.getElementById('school').value;
        let lvl = document.getElementById('level').value;
        if (!sid) return;
        fetch(`/get_departments/${sid}/${lvl}`)
            .then(res => res.json())
            .then(data => {
                let dSelect = document.getElementById('dept');
                dSelect.innerHTML = '<option value="">Select Department</option>';
                data.forEach(d => { dSelect.innerHTML += `<option value="${d.id}">${d.name}</option>`; });
                document.getElementById('subject').innerHTML = '<option value="">Select Subject</option>';
            });
    }

    function loadSubjects() {
        let deptId = document.getElementById('dept').value;
        let semId = document.getElementById('semester').value;
        let subDropdown = document.getElementById('subject');
        subDropdown.innerHTML = '<option value="">Select Subject</option>';
        
        if (deptId && semId) {
            fetch(`/get_subjects/${deptId}/${semId}`)
                .then(res => res.json())
                .then(data => {
                    data.forEach(sub => { subDropdown.innerHTML += `<option value="${sub.id}">${sub.name}</option>`; });
                    renderGrid(); 
                });
        }
    }

    function renderGrid() {
        let deptId = document.getElementById('dept').value;
        let subjectId = document.getElementById('subject').value;
        
        if (!deptId || !subjectId || subjectId === "") {
            document.getElementById('grid-header').innerHTML = "";
            document.getElementById('grid').innerHTML = "<tr><td colspan='4'>Please select a subject to see the weightage grid.</td></tr>";
            return;
        }

        fetch(`/get_pattern_details/${deptId}/${subjectId}`)
            .then(res => res.json())
            .then(data => {
                const pattern = data.config;
                const isSplit = data.is_split;
                
                let gridHeader = document.getElementById('grid-header');
                let gridBody = document.getElementById('grid');

                let headerHtml = `<tr><th>Unit</th>`;
                if (pattern.SecA) headerHtml += `<th>Sec A (${pattern.SecA.marks}M) ${isSplit ? 'T | P' : 'Theory'}</th>`;
                if (pattern.SecB) headerHtml += `<th>Sec B (${pattern.SecB.marks}M) ${isSplit ? 'T | P' : 'Theory'}</th>`;
                if (pattern.SecC) headerHtml += `<th>Sec C (${pattern.SecC.marks}M) ${isSplit ? 'T | P' : 'Theory'}</th>`;
                headerHtml += `</tr>`;
                gridHeader.innerHTML = headerHtml;

                gridBody.innerHTML = '';
                for (let i = 1; i <= 5; i++) {
                    let row = `<tr><td>Unit ${i}</td>`;
                    
                    if (pattern.SecA) {
                        row += `<td><input type="number" name="u${i}_SecA_t" class="form-control grid-input" value="0">` + 
                               (isSplit ? ` | <input type="number" name="u${i}_SecA_p" class="form-control grid-input" value="0">` : "") + `</td>`;
                    }
                    if (pattern.SecB) {
                        row += `<td><input type="number" name="u${i}_SecB_t" class="form-control grid-input" value="0">` + 
                               (isSplit ? ` | <input type="number" name="u${i}_SecB_p" class="form-control grid-input" value="0">` : "") + `</td>`;
                    }
                    if (pattern.SecC) {
                        row += `<td><input type="number" name="u${i}_SecC_t" class="form-control grid-input" value="0">` + 
                               (isSplit ? ` | <input type="number" name="u${i}_SecC_p" class="form-control grid-input" value="0">` : "") + `</td>`;
                    }
                    row += `</tr>`;
                    gridBody.innerHTML += row;
                }
            });
    }

    function uploadBank() {
    const fileInput = document.getElementById('bankFile');
    const statusDiv = document.getElementById('uploadStatus');
    
    if (fileInput.files.length === 0) {
        statusDiv.innerHTML = '<span class="text-danger">Please select a file first.</span>';
        return;
    }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    statusDiv.innerHTML = '<span class="text-primary">Uploading bank...</span>';

    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json()) // Expecting JSON from the server
    .then(data => {
        if (data.status === "success") {
            statusDiv.innerHTML = `<span class="text-success">✅ ${data.message}</span>`;
        } else {
            statusDiv.innerHTML = `<span class="text-danger">❌ ${data.message}</span>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusDiv.innerHTML = '<span class="text-danger">Upload failed. Check server console.</span>';
    });
}
</script>
</body>
</html>