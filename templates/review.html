<!DOCTYPE html>
<html>
<head>
    <title>Review & Modify Question Paper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #1a73e8; --secondary: #34a853; --warning: #fbbc04; }
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header-box { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: var(--primary); color: white; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        .badge { padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; border: none; }
        .badge-theory { background: #e8f0fe; color: #1a73e8; }
        .badge-problem { background: #fef7e0; color: #f9ab00; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; text-decoration: none; display: inline-block; font-size: 14px; transition: 0.3s; }
        .btn-back { background: #6c757d; color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-swap { background: var(--warning); color: black; padding: 5px 12px; font-size: 12px; border-radius: 4px; border: 1px solid #d39e00; }
        .btn-swap:hover { background: #e5ac00; opacity: 0.9; }
        .btn-swap:disabled { background: #ccc; cursor: not-allowed; }
        .actions { margin-top: 30px; display: flex; justify-content: space-between; align-items: center; background: #f1f3f4; padding: 20px; border-radius: 8px; }
        
        /* Loading effect */
        .swapping { opacity: 0.5; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <div>
            <h2>Review Generated Question Paper ðŸ“„</h2>
            <p class="mb-0">Subject: <strong>{{ subject }}</strong></p>
        </div>
        <div style="text-align: right;">
            <p class="mb-0 text-muted">Total Questions Selected</p>
            <h3 class="mb-0 text-primary">{{ questions|length }}</h3>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 80px;">Unit</th>
                <th style="width: 80px;">Marks</th>
                <th style="width: 100px;">K Level</th>
                <th style="width: 100px;">Type</th>
                <th>Question Text</th>
                <th style="width: 100px;">Action</th>
            </tr>
        </thead>
        <tbody>
    {% for q in questions %}
    <tr>
        <td>Unit {{ q['Unit'] }}</td>
        <td><strong>{{ q['Marks'] }}M</strong></td>
        <td><span class="badge bg-secondary">{{ q['K Level'] }}</span></td>
        <td>
            {% if q['Type'] %}
                <span class="badge {% if q['Type']|lower == 'theory' %}badge-theory{% else %}badge-problem{% endif %}">
                    {{ q['Type'] }}
                </span>
            {% else %}
                <span class="badge bg-light text-dark">Standard</span>
            {% endif %} </td>
        <td id="q-text-{{ loop.index0 }}">{{ q['Question'] }}</td>
        <td>
            <button type="button" 
                    class="btn btn-swap" 
                    id="swap-btn-{{ loop.index0 }}"
                    onclick="performSwap({{ loop.index0 }})">
                ðŸ”„ Swap
            </button>
        </td>
    </tr>
    {% endfor %}
</tbody>
    </table>

    <div class="actions">
        <button type="button" class="btn btn-back" onclick="window.history.back();">
            â¬… Edit Pattern & Grid
        </button>
        <div class="d-flex gap-2">
            <a href="{{ url_for('download_docx') }}" class="btn btn-primary">âœ… Finalize & Download (.docx)</a>
        </div>
    </div>
</div>

<script>
function performSwap(index) {
    const textCell = document.getElementById(`q-text-${index}`);
    const btn = document.getElementById(`swap-btn-${index}`);
    const kLevelCell = textCell.parentElement.cells[2].querySelector('.badge');
    // UI Feedback: Disable button and dim text
    btn.disabled = true;
    textCell.classList.add('swapping');
    const originalText = textCell.innerText;

    fetch(`/swap/${index}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update text with new question
            textCell.innerText = data.new_question;
            if (kLevelCell) {
                kLevelCell.innerText = data.new_klevel;
            }
        } else {
            // Revert and show error
            alert(data.message);
            textCell.innerText = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("An error occurred during swapping.");
        textCell.innerText = originalText;
    })
    .finally(() => {
        // Restore UI state
        btn.disabled = false;
        textCell.classList.remove('swapping');
    });
}
</script>

</body>
</html>